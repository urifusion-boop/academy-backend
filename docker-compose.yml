version: "3.9"

services:
  academy-backend.api:
    image: uriteam/urisvc:academybackenddev
    container_name: academy-backend.api
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - PORT=3000
    # restart: always
    deploy:
      restart_policy:
        condition: any
        delay: 45s
        max_attempts: 5
        window: 120s
    ports:
      - "8004:3000"
    networks:
      - uritest-network
    depends_on:
      - academy-db
      - academy-minio
      - academy-redis

  academy-redis:
    image: redis:alpine
    container_name: academy-backend.redis
    restart: always
    networks:
      - uritest-network

  academy-db:
    image: postgres:16-alpine
    container_name: academy-backend.db
    environment:
      POSTGRES_USER: uri
      POSTGRES_PASSWORD: uri
      POSTGRES_DB: uri
    restart: always
    ports:
      - "5433:5432"
    networks:
      - uritest-network
    volumes:
      - academy_postgres_data:/var/lib/postgresql/data

  academy-minio:
    image: minio/minio
    container_name: academy-backend.minio
    ports:
      - "9005:9000"
      - "9006:9001"
    environment:
      MINIO_ROOT_USER: key
      MINIO_ROOT_PASSWORD: secret
    command: server /data --console-address ":9001"
    restart: always
    networks:
      - uritest-network
    volumes:
      - academy_minio_data:/data

networks:
  uritest-network:
    external: true

volumes:
  academy_postgres_data:
  academy_minio_data:
